<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover, shrink-to-fit=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Ruokap√§iv√§kirja">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#4CAF50">
    <title>Ruokap√§iv√§kirja</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;charset=utf-8,{
        &quot;name&quot;: &quot;Ruokap√§iv√§kirja&quot;,
        &quot;short_name&quot;: &quot;Ruokalogi&quot;,
        &quot;description&quot;: &quot;Henkil√∂kohtainen ruokap√§iv√§kirja&quot;,
        &quot;start_url&quot;: &quot;./?utm_source=pwa&quot;,
        &quot;display&quot;: &quot;standalone&quot;,
        &quot;orientation&quot;: &quot;portrait&quot;,
        &quot;background_color&quot;: &quot;#667eea&quot;,
        &quot;theme_color&quot;: &quot;#4CAF50&quot;,
        &quot;categories&quot;: [&quot;health&quot;, &quot;lifestyle&quot;],
        &quot;lang&quot;: &quot;fi&quot;,
        &quot;dir&quot;: &quot;ltr&quot;,
        &quot;scope&quot;: &quot;./&quot;,
        &quot;launch_handler&quot;: {
            &quot;client_mode&quot;: &quot;navigate-existing&quot;
        },
        &quot;icons&quot;: [
            {
                &quot;src&quot;: &quot;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' fill='%234CAF50'%3E%3Ctext x='256' y='350' font-size='320' text-anchor='middle'%3EüçΩÔ∏è%3C/text%3E%3C/svg%3E&quot;,
                &quot;type&quot;: &quot;image/svg+xml&quot;,
                &quot;sizes&quot;: &quot;any&quot;,
                &quot;purpose&quot;: &quot;any maskable&quot;
            },
            {
                &quot;src&quot;: &quot;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' fill='%234CAF50' rx='20'/%3E%3Ctext x='96' y='140' font-size='100' text-anchor='middle'%3EüçΩÔ∏è%3C/text%3E%3C/svg%3E&quot;,
                &quot;type&quot;: &quot;image/svg+xml&quot;,
                &quot;sizes&quot;: &quot;192x192&quot;
            },
            {
                &quot;src&quot;: &quot;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%234CAF50' rx='50'/%3E%3Ctext x='256' y='350' font-size='280' text-anchor='middle'%3EüçΩÔ∏è%3C/text%3E%3C/svg%3E&quot;,
                &quot;type&quot;: &quot;image/svg+xml&quot;,
                &quot;sizes&quot;: &quot;512x512&quot;
            }
        ]
    }">
    
    <!-- Preload hints for PWA performance -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA4MDggODA4IiBmaWxsPSIjNENBRjUwIj48dGV4dCB4PSI3MSIgeT0iNjkiIGZpbGw9IiM2NjYiIGZvbnQtc2l6ZT0iNzVleSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+UnVva2FwW6R5c1decWphPC90ZXh0Pjwvc3ZnPg==">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding: env(safe-area-inset-top, 10px) env(safe-area-inset-right, 10px) env(safe-area-inset-bottom, 10px) env(safe-area-inset-left, 10px);
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
            touch-action: manipulation;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            min-height: calc(100vh - 20px);
            min-height: calc(-webkit-fill-available - 20px);
        }

        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .install-banner {
            background: rgba(255,255,255,0.2);
            padding: 10px 15px;
            margin: 10px -20px -10px -20px;
            text-align: left;
            font-size: 14px;
            display: none;
            align-items: center;
            gap: 10px;
            border-radius: 0;
        }

        .install-banner button {
            background: white;
            color: #4CAF50;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .date-info {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            position: sticky;
            top: 84px;
            z-index: 90;
        }

        .date-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .date-row label {
            font-weight: 600;
            min-width: 90px;
            font-size: 14px;
        }

        .date-row input, .date-row select {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            background: white;
            -webkit-appearance: none;
            appearance: none;
            min-height: 44px;
        }

        .date-row select {
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23666' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }



        .entry-form {
            padding: 20px;
            transition: all 0.3s ease;
        }

        .entry-form.editing {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 15px;
            margin: 15px;
            padding: 25px;
        }

        .entry-form.editing h2 {
            color: #856404;
            border-bottom: 2px solid #ffc107;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 15px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 16px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.3s;
            background: white;
            min-height: 44px;
            -webkit-appearance: none;
            appearance: none;
        }

        .form-group select {
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23666' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 16px;
            padding-right: 48px;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 18px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            transition: transform 0.2s, box-shadow 0.2s;
            min-height: 54px;
            position: relative;
            overflow: hidden;
        }

        .btn:hover, .btn:focus {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(76, 175, 80, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        }

        .btn-secondary:hover, .btn-secondary:focus {
            box-shadow: 0 8px 16px rgba(108, 117, 125, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .btn-danger:hover, .btn-danger:focus {
            box-shadow: 0 8px 16px rgba(220, 53, 69, 0.3);
        }

        .loading {
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .entries {
            padding: 20px;
        }

        .entry {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 16px;
            margin-bottom: 15px;
            border-left: 4px solid #4CAF50;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .entry-time {
            font-weight: 600;
            color: #4CAF50;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .entry-details {
            display: grid;
            gap: 10px;
            font-size: 14px;
        }

        .entry-detail {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .entry-label {
            font-weight: 600;
            min-width: 70px;
            color: #666;
            flex-shrink: 0;
        }

        .entry-value {
            flex: 1;
            word-break: break-word;
        }

        .quick-add {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .quick-btn {
            padding: 12px 16px;
            background: #e9ecef;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 44px;
            font-weight: 500;
        }

        .quick-btn:hover, .quick-btn:focus {
            background: #4CAF50;
            color: white;
            transform: translateY(-1px);
        }

        .quick-btn:active {
            transform: translateY(0);
        }

        .food-table {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .food-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
        }

        .food-row:first-child {
            margin-bottom: 16px;
            font-weight: 600;
            color: #666;
        }

        .food-row input {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            min-height: 44px;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .add-food-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 8px;
            min-height: 44px;
            font-weight: 500;
        }

        .export-section {
            background: #e3f2fd;
            padding: 20px;
            margin: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .export-section h3 {
            margin-bottom: 12px;
            color: #1976d2;
        }

        .export-section p {
            margin-bottom: 16px;
            color: #666;
        }

        .export-buttons {
            display: grid;
            gap: 12px;
        }

        .no-entries {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            font-style: italic;
            font-size: 16px;
        }

        .success-message, .error-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: 500;
            z-index: 1000;
            max-width: 90%;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .success-message {
            background: #4CAF50;
            color: white;
        }

        .error-message {
            background: #dc3545;
            color: white;
        }

        .info-message {
            background: #17a2b8;
            color: white;
        }

        .success-message.show, .error-message.show, .info-message.show {
            opacity: 1;
        }

        /* iOS specific improvements */
        @supports (-webkit-touch-callout: none) {
            .container {
                min-height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 20px);
            }
            
            input, select, textarea {
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }

        @media (max-width: 480px) {
            .date-row {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }
            
            .date-row label {
                min-width: auto;
                font-size: 13px;
            }
            

            
            .food-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .food-row:first-child {
                display: none; /* Hide headers on mobile */
            }
            
            .food-row input {
                margin-bottom: 4px;
            }
            
            .remove-btn {
                justify-self: end;
                width: 32px;
                height: 32px;
            }
            
            .entry-detail {
                flex-direction: column;
                gap: 4px;
            }
            
            .entry-label {
                min-width: auto;
                font-size: 13px;
            }
            
            .quick-add {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 320px) {
            .container {
                border-radius: 0;
                min-height: 100vh;
                min-height: -webkit-fill-available;
            }
            
            body {
                padding: 0;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            }
            
            .container {
                background: #1a1a1a;
                color: #ffffff;
            }
            
            .date-info, .entry, .food-table {
                background: #2d2d2d;
                color: #ffffff;
            }
            
            .form-group input, .form-group select, .form-group textarea {
                background: #2d2d2d;
                border-color: #404040;
                color: #ffffff;
            }
            
            .quick-btn {
                background: #404040;
                color: #ffffff;
            }
            
            .entry-label {
                color: #cccccc;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçΩÔ∏è Ruokap√§iv√§kirja</h1>
            <div class="install-banner" id="installBanner">
                <span>üì± Asenna sovellus kotiruutuun</span>
                <button onclick="installApp()">Asenna</button>
            </div>
        </div>

        <div class="date-info">
            <div class="date-row">
                <label>P√§iv√§m√§√§r√§:</label>
                <input type="date" id="currentDate">
            </div>
            <div class="date-row">
                <label>Viikonp√§iv√§:</label>
                <select id="weekday">
                    <option value="Maanantai">Maanantai</option>
                    <option value="Tiistai">Tiistai</option>
                    <option value="Keskiviikko">Keskiviikko</option>
                    <option value="Torstai">Torstai</option>
                    <option value="Perjantai">Perjantai</option>
                    <option value="Lauantai">Lauantai</option>
                    <option value="Sunnuntai">Sunnuntai</option>
                </select>
            </div>
            <div class="date-row">
                <label>P√§iv√§n tyyppi:</label>
                <select id="dayType">
                    <option value="Tavallinen">Tavallinen</option>
                    <option value="Poikkeava">Poikkeava</option>
                </select>
            </div>
            <div class="date-row" id="specialNote" style="display: none;">
                <label>Miten poikkeava:</label>
                <input type="text" id="specialNoteText" placeholder="Kerro miten p√§iv√§ poikkeaa">
            </div>
        </div>



        <div class="entry-form">
            <h2>Lis√§√§ ruokailu</h2>
            
            <div class="quick-add">
                <button class="quick-btn" onclick="setCurrentTime()">Nyt</button>
                <button class="quick-btn" onclick="quickFill('Koti')">Koti</button>
                <button class="quick-btn" onclick="quickFill('Koulu')">Koulu</button>
                <button class="quick-btn" onclick="quickFill('Ty√∂paikka')">Ty√∂paikka</button>
                <button class="quick-btn" onclick="quickFill('Ravintola')">Ravintola</button>
            </div>

            <div class="form-group">
                <label>Aika (klo)</label>
                <input type="time" id="mealTime">
            </div>

            <div class="form-group">
                <label>Paikka</label>
                <input type="text" id="location" placeholder="esim. koti, koulu, ravintola">
            </div>

            <div class="form-group">
                <label>Ruuat ja juomat</label>
                <div class="food-table" id="foodTable">
                    <div class="food-row">
                        <div>Ruoka/Juoma</div>
                        <div>M√§√§r√§</div>
                        <div></div>
                    </div>
                    <div class="food-row">
                        <input type="text" class="food-input" placeholder="esim. LIHAPULLAT">
                        <input type="text" class="amount-input" placeholder="esim. 5 isoa">
                        <button type="button" class="remove-btn" onclick="removeFoodRow(this)">√ó</button>
                    </div>
                </div>
                <button type="button" class="add-food-btn" onclick="addFoodRow()">+ Lis√§√§ ruoka</button>
            </div>

            <div class="form-group">
                <label>N√§l√§n aste ennen ruokailua (1-10)</label>
                <select id="hungerBefore">
                    <option value="">Valitse</option>
                    <option value="1">1 - Niin n√§lk√§, ett√§ heikottaa</option>
                    <option value="2">2 - Pit√§√§ saada heti jotakin sy√∂t√§v√§√§</option>
                    <option value="3">3 - N√§lk√§, kiire p√§√§st√§ sy√∂m√§√§n</option>
                    <option value="4">4 - Pieni n√§lk√§, ei kiirett√§ sy√∂m√§√§n</option>
                    <option value="5">5 - Tekee mieli sy√∂d√§</option>
                    <option value="6">6 - Ei tee en√§√§ mieli sy√∂d√§</option>
                    <option value="7">7 - N√§l√§nntume on poissa</option>
                    <option value="8">8 - Vatsa on t√§ynnyt</option>
                    <option value="9">9 - Vatsa on lieman t√§ysi</option>
                    <option value="10">10 - √Ñhky</option>
                </select>
            </div>

            <div class="form-group">
                <label>Kyll√§isyys ruokailun j√§lkeen (1-10)</label>
                <select id="fullnessAfter">
                    <option value="">Valitse</option>
                    <option value="1">1 - Niin n√§lk√§, ett√§ heikottaa</option>
                    <option value="2">2 - Pit√§√§ saada heti jotakin sy√∂t√§v√§√§</option>
                    <option value="3">3 - N√§lk√§, kiire p√§√§st√§ sy√∂m√§√§n</option>
                    <option value="4">4 - Pieni n√§lk√§, ei kiirett√§ sy√∂m√§√§n</option>
                    <option value="5">5 - Tekee mieli sy√∂d√§</option>
                    <option value="6">6 - Ei tee en√§√§ mieli sy√∂d√§</option>
                    <option value="7">7 - N√§l√§nntume on poissa</option>
                    <option value="8">8 - Vatsa on t√§ynnyt</option>
                    <option value="9">9 - Vatsa on lieman t√§ysi</option>
                    <option value="10">10 - √Ñhky</option>
                </select>
            </div>

            <div class="form-group">
                <label>Tunteet ja tuntemukset</label>
                <textarea id="feelings" placeholder="esim. √§rtymys, tuli sy√∂ty√§ liikaa, ei erityisi√§ tunteita"></textarea>
            </div>

            <div class="form-group">
                <label>Oireet</label>
                <textarea id="symptoms" placeholder="esim. vatsakipu, turvotus, ihottuma, p√§√§ns√§rky"></textarea>
            </div>

            <button class="btn" onclick="console.log('Button clicked!'); addEntry();">Lis√§√§ merkint√§</button>
        </div>

        <div class="entries">
            <h2>P√§iv√§n merkinn√§t</h2>
            <div id="entriesList">
                <div class="no-entries">Ei viel√§ merkint√∂j√§ t√§lle p√§iv√§lle</div>
            </div>
        </div>

        <div class="export-section">
            <h3>üì§ Vie tiedot</h3>
            <p>Vie tiedot iCloud Driveen tai muihin sovelluksiin<br>
            <small style="color: #666;">Ladataan tallennustilan tila...</small></p>
            <div class="export-buttons">
                <button class="btn btn-secondary" onclick="exportDay()">üìã Lataa p√§iv√§n merkinn√§t (CSV)</button>
                <button class="btn btn-secondary" onclick="exportAll()">üìä Lataa kaikki merkinn√§t (CSV)</button>
                <button class="btn" onclick="exportBackup()" style="background: #17a2b8;">üíæ Varmuuskopioi kaikki (JSON)</button>
                <button class="btn" onclick="importBackup()" style="background: #6f42c1;">üì• Tuo varmuuskopio</button>
                <button class="btn btn-danger" onclick="clearDay()">üóëÔ∏è Tyhjenn√§ p√§iv√§</button>
            </div>
            <input type="file" id="backupFile" accept=".json" style="display: none;" onchange="handleFileImport(this)">
        </div>
    </div>

    <script>
        // Initialize app with multiple storage options
        let entries = {};
        let storageType = 'none'; // 'localStorage', 'indexedDB', or 'none'
        
        // Check storage availability
        function checkStorageOptions() {
            // Try localStorage first
            try {
                const test = '__storage_test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                storageType = 'localStorage';
                console.log('‚úÖ localStorage available');
                return 'localStorage';
            } catch (e) {
                console.log('‚ùå localStorage blocked');
            }
            
            // Try IndexedDB as fallback
            if (window.indexedDB) {
                storageType = 'indexedDB';
                console.log('‚úÖ IndexedDB available as fallback');
                return 'indexedDB';
            }
            
            console.log('‚ö†Ô∏è No persistent storage available - using memory only');
            storageType = 'none';
            return 'none';
        }
        
        // IndexedDB helper functions
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('FoodDiaryDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('entries')) {
                        db.createObjectStore('entries', { keyPath: 'date' });
                    }
                };
            });
        }
        
        async function saveToIndexedDB() {
            try {
                const db = await openDB();
                const transaction = db.transaction(['entries'], 'readwrite');
                const store = transaction.objectStore('entries');
                
                // Save each date's entries
                for (const [date, dateEntries] of Object.entries(entries)) {
                    await store.put({ date, entries: dateEntries });
                }
                
                console.log('‚úÖ Data saved to IndexedDB');
            } catch (e) {
                console.error('‚ùå IndexedDB save failed:', e);
            }
        }
        
        async function loadFromIndexedDB() {
            try {
                const db = await openDB();
                const transaction = db.transaction(['entries'], 'readonly');
                const store = transaction.objectStore('entries');
                const request = store.getAll();
                
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => {
                        const result = {};
                        request.result.forEach(item => {
                            result[item.date] = item.entries;
                        });
                        entries = result;
                        console.log('‚úÖ Data loaded from IndexedDB');
                        resolve(result);
                    };
                    request.onerror = () => reject(request.error);
                });
            } catch (e) {
                console.error('‚ùå IndexedDB load failed:', e);
                return {};
            }
        }
        
        // Universal save function
        async function saveEntries() {
            try {
                switch (storageType) {
                    case 'localStorage':
                        localStorage.setItem('foodDiaryEntries', JSON.stringify(entries));
                        console.log('‚úÖ Saved to localStorage');
                        break;
                    case 'indexedDB':
                        await saveToIndexedDB();
                        break;
                    case 'none':
                        console.log('‚ö†Ô∏è Memory-only mode: data will be lost on page reload');
                        break;
                }
            } catch (e) {
                console.error('‚ùå Save failed:', e);
                // Auto-export as backup if save fails
                autoBackupExport();
            }
        }
        
        // Universal load function
        async function loadSavedData() {
            try {
                switch (storageType) {
                    case 'localStorage':
                        const saved = localStorage.getItem('foodDiaryEntries');
                        if (saved) {
                            entries = JSON.parse(saved);
                            console.log('‚úÖ Loaded from localStorage');
                        }
                        break;
                    case 'indexedDB':
                        await loadFromIndexedDB();
                        break;
                    case 'none':
                        entries = {};
                        break;
                }
            } catch (e) {
                console.error('‚ùå Load failed:', e);
                entries = {};
            }
        }
        
        // Auto-backup export when storage fails
        function autoBackupExport() {
            try {
                const dateStr = new Date().toISOString().split('T')[0];
                const backupData = JSON.stringify(entries, null, 2);
                const element = document.createElement('a');
                element.setAttribute('href', 'data:application/json;charset=utf-8,' + encodeURIComponent(backupData));
                element.setAttribute('download', `ruokapaivakirja_varmuuskopio_${dateStr}.json`);
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
                
                alert('Automaattinen varmuuskopio ladattu! Tallenna tiedosto turvalliseen paikkaan.');
            } catch (e) {
                console.error('Auto-backup failed:', e);
            }
        }
        
        // Set current date and weekday
        function initializeDate() {
            try {
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const dateInput = document.getElementById('currentDate');
                const weekdaySelect = document.getElementById('weekday');
                
                if (dateInput) dateInput.value = dateStr;
                
                const weekdays = ['Sunnuntai', 'Maanantai', 'Tiistai', 'Keskiviikko', 'Torstai', 'Perjantai', 'Lauantai'];
                if (weekdaySelect) weekdaySelect.value = weekdays[now.getDay()];
                
                loadTodaysEntries();
            } catch (e) {
                console.error('Error initializing date:', e);
            }
        }

        // Set current time
        function setCurrentTime() {
            try {
                const now = new Date();
                const timeStr = now.toTimeString().split(' ')[0].substring(0, 5);
                const timeInput = document.getElementById('mealTime');
                if (timeInput) timeInput.value = timeStr;
            } catch (e) {
                console.error('Error setting time:', e);
            }
        }

        // Quick fill location
        function quickFill(location) {
            try {
                const locationInput = document.getElementById('location');
                if (locationInput) locationInput.value = location;
            } catch (e) {
                console.error('Error filling location:', e);
            }
        }

        // Add food row
        function addFoodRow() {
            try {
                const foodTable = document.getElementById('foodTable');
                if (!foodTable) return;
                
                const newRow = document.createElement('div');
                newRow.className = 'food-row';
                newRow.innerHTML = `
                    <input type="text" class="food-input" placeholder="esim. LIHAPULLAT">
                    <input type="text" class="amount-input" placeholder="esim. 5 isoa">
                    <button type="button" class="remove-btn" onclick="removeFoodRow(this)">√ó</button>
                `;
                foodTable.appendChild(newRow);
                
                // Focus on the new food input
                const newFoodInput = newRow.querySelector('.food-input');
                if (newFoodInput) {
                    newFoodInput.focus();
                }
            } catch (e) {
                console.error('Error adding food row:', e);
                showMessage('Virhe lis√§tt√§ess√§ ruokarivi√§', 'error');
            }
        }

        // Remove food row
        function removeFoodRow(button) {
            try {
                const rows = document.querySelectorAll('.food-row');
                if (rows.length > 2) { // Keep at least header + one row
                    button.parentElement.remove();
                }
            } catch (e) {
                console.error('Error removing food row:', e);
            }
        }

        // Get foods and amounts from table
        function getFoodsFromTable() {
            try {
                const foods = [];
                const amounts = [];
                const foodInputs = document.querySelectorAll('.food-input');
                const amountInputs = document.querySelectorAll('.amount-input');
                
                for (let i = 0; i < foodInputs.length; i++) {
                    const foodValue = foodInputs[i] ? foodInputs[i].value.trim() : '';
                    if (foodValue) {
                        foods.push(foodValue);
                        amounts.push(amountInputs[i] ? amountInputs[i].value.trim() : '');
                    }
                }
                
                return { foods, amounts };
            } catch (e) {
                console.error('Error getting foods from table:', e);
                return { foods: [], amounts: [] };
            }
        }

        // Clear food table
        function clearFoodTable() {
            try {
                const foodInputs = document.querySelectorAll('.food-input');
                const amountInputs = document.querySelectorAll('.amount-input');
                
                foodInputs.forEach(input => {
                    if (input) input.value = '';
                });
                amountInputs.forEach(input => {
                    if (input) input.value = '';
                });
                
                // Keep only one row
                const rows = document.querySelectorAll('.food-row');
                for (let i = rows.length - 1; i > 1; i--) {
                    if (rows[i]) rows[i].remove();
                }
            } catch (e) {
                console.error('Error clearing food table:', e);
            }
        }
        async function addEntry() {
            // If in edit mode, call saveEditedEntry instead
            if (editMode) {
                await saveEditedEntry();
                return;
            }
            
            try {
                const btn = document.querySelector('button[onclick*="addEntry"]');
                if (btn) {
                    btn.classList.add('loading');
                    btn.disabled = true;
                }
                
                const date = document.getElementById('currentDate').value;
                const time = document.getElementById('mealTime').value;
                const location = document.getElementById('location').value;
                const { foods, amounts } = getFoodsFromTable();
                const hungerBefore = document.getElementById('hungerBefore').value;
                const fullnessAfter = document.getElementById('fullnessAfter').value;
                const feelings = document.getElementById('feelings').value;
                const symptoms = document.getElementById('symptoms').value;

                if (!date || !time || !location || foods.length === 0) {
                    showMessage('T√§yt√§ ainakin p√§iv√§m√§√§r√§, aika, paikka ja v√§hint√§√§n yksi ruoka', 'error');
                    return;
                }

                const entry = {
                    time,
                    location,
                    foods,
                    amounts,
                    hungerBefore,
                    fullnessAfter,
                    feelings,
                    symptoms,
                    timestamp: Date.now()
                };

                if (!entries[date]) {
                    entries[date] = [];
                }

                entries[date].push(entry);
                await saveEntries();
                loadTodaysEntries();
                clearForm();
                
                showMessage('Merkint√§ lis√§tty onnistuneesti!', 'success');
                
                // Scroll to entries section
                document.querySelector('.entries').scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
                
            } catch (error) {
                console.error('Error adding entry:', error);
                showMessage('Virhe merkint√§√§ lis√§tess√§: ' + error.message, 'error');
            } finally {
                const btn = document.querySelector('button[onclick*="addEntry"]');
                if (btn) {
                    btn.classList.remove('loading');
                    btn.disabled = false;
                }
            }
        }

        // Save entries to localStorage
        function saveEntries() {
            localStorage.setItem('foodDiaryEntries', JSON.stringify(entries));
        }

        // Load today's entries
        function loadTodaysEntries() {
            const date = document.getElementById('currentDate').value;
            const entriesList = document.getElementById('entriesList');
            
            if (!entries[date] || entries[date].length === 0) {
                entriesList.innerHTML = '<div class="no-entries">Ei viel√§ merkint√∂j√§ t√§lle p√§iv√§lle</div>';
                return;
            }

            const sortedEntries = entries[date].sort((a, b) => a.time.localeCompare(b.time));
            
            entriesList.innerHTML = sortedEntries.map((entry, index) => `
                <div class="entry">
                    <div class="entry-time">üïê ${entry.time} - üìç ${entry.location}</div>
                    <div class="entry-details">
                        <div class="entry-detail">
                            <span class="entry-label">üçΩÔ∏è Ruoat:</span>
                            <div class="entry-value">${Array.isArray(entry.foods) ? entry.foods.join(', ') : (entry.foods || '').replace(/\n/g, ', ')}</div>
                        </div>
                        <div class="entry-detail">
                            <span class="entry-label">üìè M√§√§r√§t:</span>
                            <div class="entry-value">${Array.isArray(entry.amounts) ? entry.amounts.join(', ') : (entry.amounts || '').replace(/\n/g, ', ')}</div>
                        </div>
                        ${entry.hungerBefore ? `<div class="entry-detail">
                            <span class="entry-label">üòã N√§lk√§:</span>
                            <div class="entry-value">${entry.hungerBefore}/10</div>
                        </div>` : ''}
                        ${entry.fullnessAfter ? `<div class="entry-detail">
                            <span class="entry-label">üòå Kyll√§isyys:</span>
                            <div class="entry-value">${entry.fullnessAfter}/10</div>
                        </div>` : ''}
                        ${entry.feelings ? `<div class="entry-detail">
                            <span class="entry-label">üí≠ Tunteet:</span>
                            <div class="entry-value">${entry.feelings}</div>
                        </div>` : ''}
                        ${entry.symptoms ? `<div class="entry-detail">
                            <span class="entry-label">‚öïÔ∏è Oireet:</span>
                            <div class="entry-value">${entry.symptoms}</div>
                        </div>` : ''}
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button class="btn" style="background: #17a2b8; padding: 8px 16px; font-size: 14px; flex: 1;" onclick="editEntry('${date}', ${index})">‚úèÔ∏è Muokkaa</button>
                        <button class="btn btn-danger" style="padding: 8px 16px; font-size: 14px; flex: 1;" onclick="deleteEntry('${date}', ${index})">üóëÔ∏è Poista</button>
                    </div>
                </div>
            `).join('');
        }

        // Delete entry
        function deleteEntry(date, index) {
            if (confirm('Haluatko varmasti poistaa t√§m√§n merkinn√§n?')) {
                entries[date].splice(index, 1);
                if (entries[date].length === 0) {
                    delete entries[date];
                }
                saveEntries();
                loadTodaysEntries();
            }
        }

        // Edit mode variables
        let editMode = false;
        let editingDate = null;
        let editingIndex = null;

        // Edit entry
        function editEntry(date, index) {
            const entry = entries[date][index];
            
            // Set edit mode
            editMode = true;
            editingDate = date;
            editingIndex = index;
            
            // Populate form with existing data
            document.getElementById('mealTime').value = entry.time;
            document.getElementById('location').value = entry.location;
            document.getElementById('hungerBefore').value = entry.hungerBefore || '';
            document.getElementById('fullnessAfter').value = entry.fullnessAfter || '';
            document.getElementById('feelings').value = entry.feelings || '';
            document.getElementById('symptoms').value = entry.symptoms || '';
            
            // Populate food table
            populateFoodTable(entry.foods, entry.amounts);
            
            // Update form header and button
            updateFormForEdit();
            
            // Scroll to form
            document.querySelector('.entry-form').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }

        // Populate food table with existing data
        function populateFoodTable(foods, amounts) {
            // Clear existing rows except header
            const foodTable = document.getElementById('foodTable');
            const existingRows = foodTable.querySelectorAll('.food-row');
            for (let i = existingRows.length - 1; i > 0; i--) {
                existingRows[i].remove();
            }
            
            // Convert foods and amounts to arrays if needed
            const foodArray = Array.isArray(foods) ? foods : (foods || '').toString().split('\n').filter(f => f.trim());
            const amountArray = Array.isArray(amounts) ? amounts : (amounts || '').toString().split('\n').filter(a => a.trim());
            
            // Add rows for each food item
            for (let i = 0; i < Math.max(foodArray.length, 1); i++) {
                const newRow = document.createElement('div');
                newRow.className = 'food-row';
                newRow.innerHTML = `
                    <input type="text" class="food-input" placeholder="esim. LIHAPULLAT" value="${foodArray[i] || ''}">
                    <input type="text" class="amount-input" placeholder="esim. 5 isoa" value="${amountArray[i] || ''}">
                    <button type="button" class="remove-btn" onclick="removeFoodRow(this)">√ó</button>
                `;
                foodTable.appendChild(newRow);
            }
        }

        // Update form for edit mode
        function updateFormForEdit() {
            const entryForm = document.querySelector('.entry-form');
            const formHeader = document.querySelector('.entry-form h2');
            const submitBtn = document.querySelector('.entry-form .btn[onclick*="addEntry"]');
            
            // Add editing visual style
            if (entryForm) {
                entryForm.classList.add('editing');
            }
            
            if (formHeader) {
                formHeader.innerHTML = '‚úèÔ∏è Muokkaa ruokailua';
            }
            
            if (submitBtn) {
                submitBtn.innerHTML = 'Tallenna muutokset';
                submitBtn.onclick = function() { saveEditedEntry(); };
            }
            
            // Add cancel button if it doesn't exist
            if (!document.getElementById('cancelEditBtn')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.id = 'cancelEditBtn';
                cancelBtn.className = 'btn btn-secondary';
                cancelBtn.innerHTML = 'Peruuta muokkaus';
                cancelBtn.onclick = cancelEdit;
                submitBtn.parentNode.insertBefore(cancelBtn, submitBtn.nextSibling);
            }
        }

        // Save edited entry
        async function saveEditedEntry() {
            try {
                const btn = document.querySelector('button[onclick*="saveEditedEntry"]');
                if (btn) {
                    btn.classList.add('loading');
                    btn.disabled = true;
                }
                
                const time = document.getElementById('mealTime').value;
                const location = document.getElementById('location').value;
                const { foods, amounts } = getFoodsFromTable();
                const hungerBefore = document.getElementById('hungerBefore').value;
                const fullnessAfter = document.getElementById('fullnessAfter').value;
                const feelings = document.getElementById('feelings').value;
                const symptoms = document.getElementById('symptoms').value;

                if (!time || !location || foods.length === 0) {
                    showMessage('T√§yt√§ ainakin aika, paikka ja v√§hint√§√§n yksi ruoka', 'error');
                    return;
                }

                // Update the existing entry
                const updatedEntry = {
                    time,
                    location,
                    foods,
                    amounts,
                    hungerBefore,
                    fullnessAfter,
                    feelings,
                    symptoms,
                    timestamp: entries[editingDate][editingIndex].timestamp // Keep original timestamp
                };

                entries[editingDate][editingIndex] = updatedEntry;
                await saveEntries();
                loadTodaysEntries();
                cancelEdit();
                
                showMessage('Merkint√§ p√§ivitetty onnistuneesti!', 'success');
                
            } catch (error) {
                console.error('Error saving edited entry:', error);
                showMessage('Virhe tallentaessa muutoksia: ' + error.message, 'error');
            } finally {
                const btn = document.querySelector('button[onclick*="saveEditedEntry"]');
                if (btn) {
                    btn.classList.remove('loading');
                    btn.disabled = false;
                }
            }
        }

        // Cancel edit mode
        function cancelEdit() {
            editMode = false;
            editingDate = null;
            editingIndex = null;
            
            // Reset form
            clearForm();
            
            // Remove editing visual style
            const entryForm = document.querySelector('.entry-form');
            if (entryForm) {
                entryForm.classList.remove('editing');
            }
            
            // Reset form header and button
            const formHeader = document.querySelector('.entry-form h2');
            const submitBtn = document.querySelector('.entry-form .btn[onclick*="saveEditedEntry"]');
            
            if (formHeader) {
                formHeader.innerHTML = 'Lis√§√§ ruokailu';
            }
            
            if (submitBtn) {
                submitBtn.innerHTML = 'Lis√§√§ merkint√§';
                submitBtn.onclick = function() { addEntry(); };
            }
            
            // Remove cancel button
            const cancelBtn = document.getElementById('cancelEditBtn');
            if (cancelBtn) {
                cancelBtn.remove();
            }
        }

        // Clear form
        function clearForm() {
            document.getElementById('mealTime').value = '';
            document.getElementById('location').value = '';
            clearFoodTable();
            document.getElementById('hungerBefore').value = '';
            document.getElementById('fullnessAfter').value = '';
            document.getElementById('feelings').value = '';
            document.getElementById('symptoms').value = '';
        }

        // Export day to CSV
        function exportDay() {
            try {
                const date = document.getElementById('currentDate').value;
                const weekday = document.getElementById('weekday').value;
                const dayType = document.getElementById('dayType').value;
                const specialNote = document.getElementById('specialNoteText').value;
                
                let csvContent = '';
                
                // Add header info
                csvContent += `P√§iv√§m√§√§r√§,${date}\n`;
                csvContent += `Viikonp√§iv√§,${weekday}\n`;
                csvContent += `P√§iv√§n tyyppi,${dayType}\n`;
                if (specialNote) csvContent += `Poikkeava,${specialNote}\n`;
                csvContent += '\n';
                
                // CSV headers
                csvContent += 'Aika,Paikka,Ruoka/Juoma,M√§√§r√§,N√§lk√§ ennen,Kyll√§isyys j√§lkeen,Tunteet,Oireet\n';
                
                if (entries[date]) {
                    const sortedEntries = entries[date].sort((a, b) => a.time.localeCompare(b.time));
                    sortedEntries.forEach(entry => {
                        const foods = Array.isArray(entry.foods) ? entry.foods : (entry.foods || '').toString().split('\n').filter(f => f.trim());
                        const amounts = Array.isArray(entry.amounts) ? entry.amounts : (entry.amounts || '').toString().split('\n').filter(a => a.trim());
                        
                        // Ensure we have at least one food item
                        if (foods.length === 0) foods.push('');
                        
                        foods.forEach((food, i) => {
                            const amount = amounts[i] || '';
                            const row = [
                                i === 0 ? entry.time : '',
                                i === 0 ? entry.location : '',
                                `"${food.trim()}"`,
                                `"${amount.trim()}"`,
                                i === 0 ? (entry.hungerBefore || '') : '',
                                i === 0 ? (entry.fullnessAfter || '') : '',
                                i === 0 ? `"${entry.feelings || ''}"` : '',
                                i === 0 ? `"${entry.symptoms || ''}"` : ''
                            ];
                            csvContent += row.join(',') + '\n';
                        });
                    });
                }
                
                downloadCSV(`ruokapaivakirja_${date}.csv`, csvContent);
            } catch (e) {
                console.error('Error exporting day:', e);
                alert('Virhe viedess√§ tietoja. Yrit√§ uudelleen.');
            }
        }

        // Export all to CSV
        function exportAll() {
            try {
                let csvContent = 'P√§iv√§m√§√§r√§,Viikonp√§iv√§,Aika,Paikka,Ruoka/Juoma,M√§√§r√§,N√§lk√§ ennen,Kyll√§isyys j√§lkeen,Tunteet,Oireet\n';
                
                Object.keys(entries).sort().forEach(date => {
                    const sortedEntries = entries[date].sort((a, b) => a.time.localeCompare(b.time));
                    
                    sortedEntries.forEach(entry => {
                        const foods = Array.isArray(entry.foods) ? entry.foods : (entry.foods || '').toString().split('\n').filter(f => f.trim());
                        const amounts = Array.isArray(entry.amounts) ? entry.amounts : (entry.amounts || '').toString().split('\n').filter(a => a.trim());
                        
                        // Ensure we have at least one food item
                        if (foods.length === 0) foods.push('');
                        
                        foods.forEach((food, i) => {
                            const amount = amounts[i] || '';
                            const row = [
                                i === 0 ? date : '',
                                i === 0 ? '' : '', // weekday not stored in old format
                                i === 0 ? entry.time : '',
                                i === 0 ? entry.location : '',
                                `"${food.trim()}"`,
                                `"${amount.trim()}"`,
                                i === 0 ? (entry.hungerBefore || '') : '',
                                i === 0 ? (entry.fullnessAfter || '') : '',
                                i === 0 ? `"${entry.feelings || ''}"` : '',
                                i === 0 ? `"${entry.symptoms || ''}"` : ''
                            ];
                            csvContent += row.join(',') + '\n';
                        });
                    });
                });
                
                downloadCSV('ruokapaivakirja_kaikki.csv', csvContent);
            } catch (e) {
                console.error('Error exporting all:', e);
                alert('Virhe viedess√§ tietoja. Yrit√§ uudelleen.');
            }
        }

        // Download CSV file
        function downloadCSV(filename, csvContent) {
            try {
                const BOM = '\uFEFF'; // Add BOM for proper Excel encoding
                const element = document.createElement('a');
                element.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(BOM + csvContent));
                element.setAttribute('download', filename);
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
            } catch (e) {
                console.error('Error downloading CSV:', e);
                alert('Virhe latauksen aikana. Yrit√§ uudelleen.');
            }
        }

        // Backup and restore functions
        function exportBackup() {
            try {
                const backupData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    entries: entries
                };
                
                const dataStr = JSON.stringify(backupData, null, 2);
                const element = document.createElement('a');
                element.setAttribute('href', 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr));
                element.setAttribute('download', `ruokapaivakirja_varmuuskopio_${new Date().toISOString().split('T')[0]}.json`);
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
                
                alert('Varmuuskopio ladattu! Tallenna tiedosto turvalliseen paikkaan.');
            } catch (e) {
                console.error('Backup export failed:', e);
                alert('Varmuuskopion luominen ep√§onnistui: ' + e.message);
            }
        }
        
        function importBackup() {
            document.getElementById('backupFile').click();
        }
        
        async function handleFileImport(input) {
            try {
                const file = input.files[0];
                if (!file) return;
                
                const text = await file.text();
                const backupData = JSON.parse(text);
                
                if (backupData.entries) {
                    if (confirm('Haluatko korvata nykyiset tiedot varmuuskopiolla? T√§m√§ poistaa kaikki nykyiset merkinn√§t.')) {
                        entries = backupData.entries;
                        await saveEntries();
                        loadTodaysEntries();
                        alert('Varmuuskopio tuotu onnistuneesti!');
                    }
                } else {
                    alert('Virheellinen varmuuskopiotiedosto.');
                }
            } catch (e) {
                console.error('Import failed:', e);
                alert('Varmuuskopion tuominen ep√§onnistui: ' + e.message);
            }
            
            // Reset file input
            input.value = '';
        }

        // Event listeners and initialization
        function setupEventListeners() {
            try {
                const dayTypeSelect = document.getElementById('dayType');
                const dateInput = document.getElementById('currentDate');
                
                if (dayTypeSelect) {
                    dayTypeSelect.addEventListener('change', function() {
                        const specialNote = document.getElementById('specialNote');
                        if (specialNote) {
                            if (this.value === 'Poikkeava') {
                                specialNote.style.display = 'flex';
                            } else {
                                specialNote.style.display = 'none';
                            }
                        }
                    });
                }

                if (dateInput) {
                    dateInput.addEventListener('change', function() {
                        try {
                            const date = new Date(this.value);
                            const weekdays = ['Sunnuntai', 'Maanantai', 'Tiistai', 'Keskiviikko', 'Torstai', 'Perjantai', 'Lauantai'];
                            const weekdaySelect = document.getElementById('weekday');
                            if (weekdaySelect) {
                                weekdaySelect.value = weekdays[date.getDay()];
                            }
                            loadTodaysEntries();
                        } catch (e) {
                            console.error('Error handling date change:', e);
                        }
                    });
                }
            } catch (e) {
                console.error('Error setting up event listeners:', e);
            }
        }

        // Legacy function - now split into smaller parts for better PWA performance
        async function initializeApp() {
            try {
                console.log('Initializing food diary app...');
                
                // Detect and setup storage
                const storage = checkStorageOptions();
                console.log('Storage method:', storage);
                
                // Load existing data
                await loadSavedData();
                
                // Setup UI
                initializeDate();
                setCurrentTime();
                setupEventListeners();
                
                // Update storage status in UI
                updateStorageStatus(storage);
                
                console.log('App initialized successfully with', storage, 'storage');
            } catch (e) {
                console.error('Error initializing app:', e);
                alert('Sovelluksen lataus ep√§onnistui. P√§ivit√§ sivu ja yrit√§ uudelleen.');
            }
        }
        
        // PWA Installation
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallBanner();
        });
        
        function showInstallBanner() {
            const banner = document.getElementById('installBanner');
            if (banner) {
                banner.style.display = 'flex';
            }
        }
        
        async function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    showMessage('Sovellus asennettu onnistuneesti!', 'success');
                }
                deferredPrompt = null;
                hideInstallBanner();
            } else {
                // For iOS Safari - show instructions
                showMessage('iPhone: Jaa > Lis√§√§ kotiruutuun', 'info');
            }
        }
        
        function hideInstallBanner() {
            const banner = document.getElementById('installBanner');
            if (banner) {
                banner.style.display = 'none';
            }
        }
        
        // Enhanced message system
        function showMessage(message, type = 'success', duration = 3000) {
            const messageEl = document.createElement('div');
            messageEl.className = `${type}-message show`;
            messageEl.textContent = message;
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.classList.remove('show');
                setTimeout(() => {
                    if (messageEl.parentNode) {
                        messageEl.parentNode.removeChild(messageEl);
                    }
                }, 300);
            }, duration);
        }
        
        // Update UI to show storage status
        function updateStorageStatus(storage) {
            const exportSection = document.querySelector('.export-section p');
            if (exportSection) {
                let statusText = 'Vie tiedot iCloud Driveen tai muihin sovelluksiin<br>';
                switch (storage) {
                    case 'localStorage':
                        statusText += '<small style="color: #28a745;">‚úÖ Tiedot tallennetaan pysyv√§sti laitteellesi</small>';
                        break;
                    case 'indexedDB':
                        statusText += '<small style="color: #28a745;">‚úÖ Tiedot tallennetaan IndexedDB:hen (pysyv√§)</small>';
                        break;
                    case 'none':
                        statusText += '<small style="color: #dc3545;">‚ö†Ô∏è Tiedot s√§ilyv√§t vain istunnon ajan - muista vied√§ varmuuskopio!</small>';
                        break;
                }
                exportSection.innerHTML = statusText;
            }
        }

        // Clear day
        function clearDay() {
            try {
                const date = document.getElementById('currentDate').value;
                if (confirm(`Haluatko varmasti poistaa kaikki merkinn√§t p√§iv√§lt√§ ${date}?`)) {
                    delete entries[date];
                    saveEntries();
                    loadTodaysEntries();
                }
            } catch (e) {
                console.error('Error clearing day:', e);
            }
        }

        // Service Worker registration for PWA support
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    // Simple service worker for basic caching
                    const swCode = `
                        const CACHE_NAME = 'ruokapaivakirja-v1';
                        const urlsToCache = [
                            '${window.location.pathname}',
                            'data:application/json;base64,${btoa(JSON.stringify({
                                name: 'Ruokap√§iv√§kirja',
                                short_name: 'Ruokalogi',
                                display: 'standalone',
                                background_color: '#667eea',
                                theme_color: '#4CAF50'
                            }))}'
                        ];
                        
                        self.addEventListener('install', (event) => {
                            event.waitUntil(
                                caches.open(CACHE_NAME)
                                    .then((cache) => cache.addAll(urlsToCache))
                            );
                        });
                        
                        self.addEventListener('fetch', (event) => {
                            event.respondWith(
                                caches.match(event.request)
                                    .then((response) => {
                                        return response || fetch(event.request);
                                    }
                                )
                            );
                        });
                    `;
                    
                    const blob = new Blob([swCode], { type: 'application/javascript' });
                    const swUrl = URL.createObjectURL(blob);
                    
                    await navigator.serviceWorker.register(swUrl);
                    console.log('‚úÖ Service Worker registered successfully');
                } catch (error) {
                    console.log('‚ùå Service Worker registration failed:', error);
                }
            }
        }

        // Simple password protection that works with any storage type
        let appPassword = null;
        let isAuthenticated = false;
        
        function checkPassword() {
            // If already authenticated this session, allow access
            if (isAuthenticated) {
                return true;
            }
            
            // Detect storage availability for password (independent check)
            let passwordStorageAvailable = false;
            try {
                const test = '__password_test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                passwordStorageAvailable = true;
            } catch (e) {
                passwordStorageAvailable = false;
            }
            
            // Try to load saved password
            if (!appPassword) {
                try {
                    if (passwordStorageAvailable) {
                        appPassword = localStorage.getItem('foodDiaryPassword');
                    } else {
                        // Use sessionStorage as fallback
                        appPassword = sessionStorage.getItem('foodDiaryPassword');
                    }
                } catch (e) {
                    console.log('Could not load saved password');
                }
            }
            
            // If no password set, ask user to set one
            if (!appPassword) {
                appPassword = prompt("üîí Aseta salasana ruokap√§iv√§kirjalle (muista t√§m√§!):");
                if (!appPassword) {
                    return false;
                }
                
                // Try to save the password
                try {
                    if (passwordStorageAvailable) {
                        localStorage.setItem('foodDiaryPassword', appPassword);
                        console.log('‚úÖ Password saved to localStorage');
                    } else {
                        sessionStorage.setItem('foodDiaryPassword', appPassword);
                        console.log('‚úÖ Password saved to sessionStorage');
                    }
                } catch (e) {
                    console.log('Could not save password, using session only');
                }
                
                alert("‚úÖ Salasana asetettu! K√§yt√§ t√§t√§ samaa salasanaa jatkossa.");
                isAuthenticated = true;
                return true;
            }
            
            // Ask for password
            const password = prompt("üîí Anna salasana p√§√§st√§ksesi ruokap√§iv√§kirjaan:");
            if (password === appPassword) {
                isAuthenticated = true;
                return true;
            } else if (password !== null) {
                alert("‚ùå V√§√§r√§ salasana!");
                return false;
            } else {
                return false;
            }
        }

        // Enhanced app initialization with PWA performance optimizations
        async function fullInitialize() {
            // Show loading state immediately for PWA
            const isPWA = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
            
            if (isPWA) {
                showPWALoader();
            }
            
            // Check password first
            if (!checkPassword()) {
                document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;color:#666;">üîí P√§√§sy ev√§tty</div>';
                return;
            }
            
            // Fast UI initialization first
            initializeDateSync();
            setCurrentTime();
            setupEventListeners();
            
            if (isPWA) {
                hidePWALoader();
            }
            
            // Lazy load heavy operations
            setTimeout(async () => {
                await initializeStorageAndData();
                await registerServiceWorker();
                
                // Auto-backup reminder (weekly)
                const lastBackup = localStorage.getItem('lastBackupReminder');
                const now = Date.now();
                const oneWeek = 7 * 24 * 60 * 60 * 1000;
                
                if (!lastBackup || (now - parseInt(lastBackup)) > oneWeek) {
                    setTimeout(() => {
                        if (Object.keys(entries).length > 0) {
                            showMessage('üíæ Muista vied√§ varmuuskopio iCloud Driveen!', 'info', 5000);
                            localStorage.setItem('lastBackupReminder', now.toString());
                        }
                    }, 10000); // Show after 10 seconds
                }
            }, 100); // Small delay to let UI render first
        }
        
        // Show loading for PWA mode
        function showPWALoader() {
            const loader = document.createElement('div');
            loader.id = 'pwaLoader';
            loader.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                display: flex; align-items: center; justify-content: center;
                z-index: 10000; color: white; font-family: -apple-system, BlinkMacSystemFont, sans-serif;
                flex-direction: column; gap: 20px;
            `;
            loader.innerHTML = `
                <div style="font-size: 48px;">üçΩÔ∏è</div>
                <div style="font-size: 18px; font-weight: 600;">Ruokap√§iv√§kirja</div>
                <div style="width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            `;
            document.body.appendChild(loader);
        }
        
        function hidePWALoader() {
            const loader = document.getElementById('pwaLoader');
            if (loader) {
                loader.style.opacity = '0';
                loader.style.transition = 'opacity 0.3s';
                setTimeout(() => loader.remove(), 300);
            }
        }
        
        // Synchronous date initialization (no async)
        function initializeDateSync() {
            try {
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const dateInput = document.getElementById('currentDate');
                const weekdaySelect = document.getElementById('weekday');
                
                if (dateInput) dateInput.value = dateStr;
                
                const weekdays = ['Sunnuntai', 'Maanantai', 'Tiistai', 'Keskiviikko', 'Torstai', 'Perjantai', 'Lauantai'];
                if (weekdaySelect) weekdaySelect.value = weekdays[now.getDay()];
            } catch (e) {
                console.error('Error initializing date:', e);
            }
        }
        
        // Separate storage and data loading
        async function initializeStorageAndData() {
            try {
                console.log('Initializing storage and data...');
                
                // Detect and setup storage
                const storage = checkStorageOptions();
                console.log('Storage method:', storage);
                
                // Load existing data
                await loadSavedData();
                
                // Load today's entries
                loadTodaysEntries();
                
                // Update storage status in UI
                updateStorageStatus(storage);
                
                console.log('Storage and data initialized successfully');
            } catch (e) {
                console.error('Error initializing storage and data:', e);
            }
        }

        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', fullInitialize);
        } else {
            fullInitialize();
        }
    </script>
</body>
</html>